<!-- Loading Spinner -->
<div class="spinner-container" *ngIf="loading">
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</div>

<div class="container mt-4" [class.loading-cursor]="loading" [class.loading-overlay]="loading">
  <!-- ============================= -->
  <!-- TWO TABS SECTION -->
  <!-- ============================= -->

  <mat-tab-group animationDuration="300ms">
    <!-- ================================= -->
    <!-- TAB 1 : EMPLOYEE MANAGEMENT -->
    <!-- ================================= -->
    <mat-tab label="Add Employee">
      <div class="container mt-4">
        <h3 class="page-title">Employee Management</h3>

        <div class="card p-4 mb-4">
          <form #empForm="ngForm" (ngSubmit)="addEmployee(empForm)">
            <div class="row g-3">
              <div class="col-md-3">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Employee ID"
                  [(ngModel)]="form.employee_id"
                  name="employee_id"
                  #employeeId="ngModel"
                  required
                  pattern="^[0-9]+$"
                />
                @if (employeeId.invalid && employeeId.touched) {
                  <div class="text-danger mt-1">
                    @if (employeeId.errors?.['required']) {
                      <small>Employee ID is required</small>
                    }
                    @if (employeeId.errors?.['pattern']) {
                      <small>Employee ID must contain numbers only</small>
                    }
                  </div>
                }
              </div>

              <div class="col-md-3">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Full Name"
                  [(ngModel)]="form.full_name"
                  name="full_name"
                  required
                  #fullName="ngModel"
                />
                @if (fullName.invalid && fullName.touched) {
                  <div class="text-danger mt-1">
                    <small>Full Name is required</small>
                  </div>
                }
              </div>

              <div class="col-md-3">
                <input
                  type="email"
                  class="form-control"
                  placeholder="Email (e.g. name@gmail.com)"
                  [(ngModel)]="form.email"
                  name="email"
                  required
                  pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                  #email="ngModel"
                />

                @if (email.invalid && email.touched) {
                  <div class="text-danger mt-1">
                    @if (email.errors?.['required']) {
                      <small>Email is required</small>
                    }
                    @if (email.errors?.['pattern']) {
                      <small>Enter a valid email address like name@gmail.com</small>
                    }
                  </div>
                }
              </div>

              <div class="col-md-2">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Department"
                  [(ngModel)]="form.department"
                  name="department"
                  required
                  #department="ngModel"
                />
                @if (department.invalid && department.touched) {
                  <div class="text-danger mt-1">
                    <small>Department is required</small>
                  </div>
                }
              </div>

              <div class="col-md-1 d-grid">
                <button
                  type="submit"
                  mat-raised-button
                  color="primary"
                  [disabled]="empForm.invalid"
                >
                  <mat-icon>add</mat-icon>
                  Add
                </button>
              </div>
            </div>
          </form>

          <!-- @if (errorMessage != '') {
      <div class="alert alert-danger mt-3">
        {{ errorMessage }}
      </div>
    } -->
        </div>
      </div>
    </mat-tab>
    <!-- ================================= -->
    <!-- TAB 2 : ATTENDANCE MANAGEMENT -->
    <!-- ================================= -->
    <mat-tab label="Add Attendance">
      <div class="container mt-4">
        <h3 class="page-title">Attendance Management</h3>

        <div class="card p-4 mb-4">
          <form #attendanceForm="ngForm" (ngSubmit)="markAttendance(attendanceForm)">
            <div class="row g-3">
              <div class="col-md-4">
                <select
                  title="attendanceEmployees"
                  class="form-select"
                  [(ngModel)]="attendance.employee_id"
                  name="employee_id"
                  #attendanceemployeeId="ngModel"
                  required
                >
                  <option value="">Select Employee</option>
                  <option *ngFor="let emp of employees" [value]="emp.id">
                    {{ emp.full_name }}
                  </option>
                </select>
                @if (attendanceemployeeId.invalid && attendanceemployeeId.touched) {
                  <div class="text-danger mt-1">
                    @if (attendanceemployeeId.errors?.['required']) {
                      <small>Employee is required</small>
                    }
                  </div>
                }
              </div>

              <div class="col-md-4">
                <input
                  title="attendanceDate"
                  type="date"
                  class="form-control"
                  [(ngModel)]="attendance.attendance_date"
                  name="attendance_date"
                  #attendanceDate="ngModel"
                  required
                />
                @if (attendanceDate.invalid && attendanceDate.touched) {
                  <div class="text-danger mt-1">
                    @if (attendanceDate.errors?.['required']) {
                      <small>Attendance date is required</small>
                    }
                  </div>
                }
              </div>

              <div class="col-md-3">
                <select
                  title="attendanceStatus"
                  class="form-select"
                  [(ngModel)]="attendance.status"
                  name="status"
                  #status="ngModel"
                  required
                >
                  <option value="">Status</option>
                  <option value="Present">Present</option>
                  <option value="Absent">Absent</option>
                </select>
                @if (status.invalid && status.touched) {
                  <div class="text-danger mt-1">
                    @if (status.errors?.['required']) {
                      <small>Status is required</small>
                    }
                  </div>
                }
              </div>

              <div class="col-md-1 d-grid">
                <button
                  type="submit"
                  mat-raised-button
                  color="primary"
                  [disabled]="attendanceForm.invalid"
                >
                  <mat-icon>fact_check</mat-icon>
                  Mark
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
  <div class="container mt-4">
    <div class="card p-3">
      @if (employees.length === 0) {
        <div class="text-center p-4 text-muted">No employees found.</div>
      } @else {
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z1 w-100">
          <!-- ID -->
          <ng-container matColumnDef="employee_id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let emp">
              {{ emp.employee_id }}
            </td>
          </ng-container>

          <!-- Name -->
          <ng-container matColumnDef="full_name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let emp">
              {{ emp.full_name }}
            </td>
          </ng-container>

          <!-- Email -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let emp">
              {{ emp.email }}
            </td>
          </ng-container>

          <!-- Department -->
          <ng-container matColumnDef="department">
            <th mat-header-cell *matHeaderCellDef>Department</th>
            <td mat-cell *matCellDef="let emp">
              {{ emp.department }}
            </td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-end">Actions</th>
            <td mat-cell *matCellDef="let emp" class="text-end">
              <button
                mat-icon-button
                color="warn"
                matTooltip="Delete Employee"
                (click)="deleteEmployee(emp.id!)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Attendance -->
          <ng-container matColumnDef="attendance">
            <th mat-header-cell *matHeaderCellDef class="text-end">Attendance</th>
            <td mat-cell *matCellDef="let emp" class="text-end">
              <button mat-raised-button color="primary" (click)="viewAttendance(emp.id!)">
                View
              </button>
            </td>
          </ng-container>

          <!-- Header & Rows -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>

        <!-- Paginator -->
        <mat-paginator [pageSize]="5" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons>
        </mat-paginator>
      }
    </div>
  </div>
</div>
